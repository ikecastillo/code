define("jira/mail/views/settings-view",["jira/mail/entities/projects","jira/mail/entities/issue-types","jira/mail/entities/bulk-options","jira/mail/views/checkbox-view","jira/mail/views/text-view","jira/mail/views/default-reporter-view","jira/mail/views/projects-view","jira/mail/views/issue-types-view","jira/mail/views/bulk-options-view","jira/ajs/ajax/smart-ajax","jira/flag","jquery","backbone","underscore"],function(c,m,n,b,h,d,i,j,e,a,f,g,l,k){return l.View.extend({events:{"click #testButton":"testHandler",submit:"saveHandler"},initialize:function(){k.bindAll(this,"testHandler","saveHandler","testResultsInlineContent","testCompleteHandler");this.model.bind("change",this.modelChanged,this)},render:function(){if(jQuery("#project").length>0){this.projectsView=new i({el:jQuery("#project"),model:this.model,collection:new c(this.options.availableProjects)}).render();this.issueTypesView=new j({el:jQuery("#issuetype"),model:this.model,collection:new m()}).render();this.projectsView.issueTypesView=this.issueTypesView}this.createusersView=new b({el:jQuery("#createusers"),model:this.model}).render();this.notifyusersView=new b({el:jQuery("#notifyusers"),model:this.model}).render();this.reporterView=new d({el:jQuery("#reporterusername"),model:this.model}).render();this.catchemailView=new h({el:jQuery("#catchemail"),model:this.model}).render();this.forwardEmailView=new h({el:jQuery("#forwardEmail"),model:this.model}).render();if(jQuery("#stripquotes").length>0){this.stripquotes=new b({el:jQuery("#stripquotes"),model:this.model}).render()}if(jQuery("#splitregex").length>0){this.splitregexView=new h({el:jQuery("#splitregex"),model:this.model}).render()}if(jQuery("#ccwatcher").length>0){this.ccwatcherView=new b({el:jQuery("#ccwatcher"),model:this.model}).render();this.ccassigneeView=new b({el:jQuery("#ccassignee"),model:this.model}).render()}this.bulkOptionsView=new e({el:jQuery("#bulk"),model:this.model,collection:new n(this.options.availableBulkOptions)}).render();this.modelChanged();return this},getModelAsString:function(){var o=this.model.toJSON();if(this.model.get("createusers")){delete o.reporterusername}return JSON.stringify(o)},testResultsInlineContent:function(q,p,o){var r=this.testResult||{};q.html(JIRA.Templates.Mail.testDialog({data:r}));o()},testCompleteHandler:function(p,q,o){jQuery(".buttons .throbber:last").removeClass("loading");if(o.successful){this.testResult=o.data}else{this.testResult={succeeded:false,errors:[a.buildSimpleErrorContent(o)]}}if(this.testResult.succeeded){if(this.testResult.stats.messages==0){jQuery("#mailHandlerForm .buttons .test-placeholder").html(JIRA.Templates.Mail.InlineMessage.info({message:AJS.I18n.getText("jmp.editHandlerDetails.testDialog.nomessages")}))}else{jQuery("#mailHandlerForm .buttons .test-placeholder").html(JIRA.Templates.Mail.InlineMessage.success({message:AJS.I18n.getText("jmp.editHandlerDetails.testDialog.success")}))}}else{jQuery("#mailHandlerForm .buttons .test-placeholder").html(JIRA.Templates.Mail.InlineMessage.error({message:AJS.I18n.getText("jmp.editHandlerDetails.testDialog.error")}))}jQuery("#mailHandlerForm .buttons .test-placeholder a").click({dialog:this},function(r){r.data.dialog.testResultsInlineDialog.show();r.preventDefault()});JIRA.trace("jira.mail.edit.handler.test.finished")},testHandler:function(p){p.preventDefault();var o={detailsJson:this.getModelAsString()};jQuery("#mailHandlerForm .buttons .test-placeholder").html("");jQuery(".buttons .throbber:last").addClass("loading");if(this.testResultsInlineDialog==undefined){this.testResultsInlineDialog=new AJS.InlineDialog(jQuery("#mailHandlerForm div.buttons .test-placeholder"),"test-results-popup",this.testResultsInlineContent,{width:550,onHover:false,onTop:true,noBind:true,cacheContent:false})}else{this.testResultsInlineDialog.hide()}a.makeRequest({url:contextPath+"/rest/jira-mail-plugin/1.0/message-handlers/test?atl_token="+atl_token(),type:"POST",dataType:"json",data:o,complete:this.testCompleteHandler})},saveHandler:function(){jQuery("#details").val(this.getModelAsString())},modelChanged:function(){jQuery(".icon-required",jQuery("div.field-group.forwardEmail")).toggle(this.model.get("bulk")=="forward");jQuery(".hints-section").toggle(this.model.get("createusers")!=true&&(this.model.get("reporterusername")==undefined||this.model.get("reporterusername")==""));jQuery("#testButton").attr("disabled","disabled");var o={detailsJson:this.getModelAsString()};a.makeRequest({url:contextPath+"/rest/jira-mail-plugin/1.0/message-handlers/validate?atl_token="+atl_token(),type:"POST",dataType:"json",data:o,complete:function(r,s,p){if(p.successful){var q=false;jQuery(".field-group div.error").remove();jQuery("div.aui-message.error").remove();if(p.data.globalErrors!=undefined&&p.data.globalErrors.length>0){q=true;jQuery.each(p.data.globalErrors,function(t,u){f.showErrorMsg(jQuery(".global-errors-location"),u,{shadowed:false,closeable:false})})}if(jQuery.isEmptyObject(p.data.fieldErrors)==false){q=true;jQuery.each(p.data.fieldErrors,function(t,u){jQuery(".field-group."+t+" span.element-wrapper").append("<div class='error'>"+u+"</div>")})}jQuery("#testButton").prop("disabled",q)}else{jQuery("#testButton").prop("disabled",true)}}})}})});